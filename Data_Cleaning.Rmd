---
title: "generate_local_datasets"
author: "Bruno Valan"
date: "2023-03-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(haven)
library(dplyr)
library(plyr)
library(ggplot2)
library(ggrepel)
library(corrplot)
library(patchwork)
library(psych)
library(tidyverse)
library(gridExtra)
library(naniar)
library(caret)
library(randomForest)
require(caTools)

```

## R Markdown
The goal of this file is to simplify our original data set. I will do this by 
1) dropping many of the columns that will either cause leakage or that we know will be irrelevant (including other response variables besides readmission1 = Yes)
3) I will handle missingness in the remaining columns (impute or drop rows)
4) I will split the data into training and test sets and save both 
5) I will use the training set into create four smaller data frames with local features relating to certain characteristics, specifically
  1) pre-operative patient health 
  2) patient demographics 
  3) post-operative health and complications
  4) procedure information (including hospital information)

```{r}
#first I will read in the full data set 
raw_data = read_sav('../Data/HipFractureQualityData.sav')

```


```{r}
#these are the columns that will cause leakage 
cols_leakage_encoded = c('ReadmissionPost_117', 'Readmission2Post_1', 'Readmission2Post_2', 'Readmission2Post_3', 'Readmission3Post_4', 'Readmission3Post_5', 'Mortality', 'AnyAdverseEvent', 'ClaivenDindo', 'PostOpResidence30_36', 'PostOpResidence30_37', 'PostOpResidence30_38', 'PostOpResidence30_39', 'PostOpResidence30_40', 'PostOpResidence30_41', 'PostOpResidence30_42', 'PostOpResidence30_43')

#drops the columns that will cause leakage
df_simplified <- select(raw_data, -cols_leakage_encoded)

#some of these may have already been encoded but I don't think so. Also our un encoded response is being dropped here
#dropped all days 
cols_leakage_original = c("STILLINHOSP", "REOPERATION1", "REOPORCPT1", "REOPERATION2", "RETOR2PODAYS", "REOPOR2CPT1", "RETOR2RELATED", "REOPOR2ICD91", "REOPERATION3", "READMISSION1", "READMPODAYS1", "UNPLANNEDREADMISSION1", "READMRELATED1", "READMSUSPREASON1", "READMISSION2", "READMPODAYS2", "UNPLANNEDREADMISSION2", "READMRELATED2", "READMRELICD92", "READMISSION3","READMPODAYS3", "UNPLANNEDREADMISSION3", "READMRELATED3", "READMSUSPREASON3", "READMRELICD93" )

#drops the original columns that will cause leakage 
df_simplified <- select(df_simplified, -cols_leakage_original)


#dropped encoded missingness, BMI cats, 
#dropped columns that were dummy encoded for a binary variable (re-oppost_115, Stroke_1)
#dropped 3 level diabetes column (keep binary)
#dropped post complication columns indicating indicating no complication (WBAT 18/19)
encoded_irrelevant <- c("MissingRaceStudy", "Age65", "QualityMetric", "QualityGreater2", "casematch22", "albuminmissing", 'MissingVariableInfo2', 'BMICategories', 'agemissing', 'HtMissing1', 'WtMissing1', 'LOSmissing', 'ReOPPost_115', 'DiabetesPre_33', 'DiabetesPre_34', 'DiabetesPre_35', 'Stroke_1', 'Ethnicity_12', 'Ethnicity_13', 'StrokePost_101', 'WBATPOD1_18', 'WBATPOD1_19', 'PreOpDelirium_3', 'PreOpMOBAID_9', 'DVTProphylaxisPost28_22', 'PostOpDelirium_27', 'PreOpMOBAID_9', 'PostOpMobAid_30', 'PostOpMobAid_32')

#at this point all the encoded columns that exist are relevant to us - I have documented what is encoded in the google drive
df_simplified <- select(df_simplified, -encoded_irrelevant)


#original columns to drop 
original_drop <- c('CASEID','HIP_RES30D', 'PRNCPTX', 'ADMYR', 'SURGSPEC', 'READMSUSPREASON2', 'RETORRELATED', 'BLEED_UNITS_TOT', 'DOTHCDIFF', 'NOTHCDIFF', 'DOTHCDIFF', 'ANESTHES_OTHER', 'PODIAG_OTHER10', 'PODIAG_OTHER', 'WOUND_CLOSURE', 'DOPERTOD', 'PODIAGTX10', 'PODIAG10', 'PODIAGTX', 'PODIAG', 'DOTHSESHOCK', 'DOTHSYSEP', "OTHERPROC1", "OTHERCPT1", "OTHERWRVU1", "OTHERPROC2", "OTHERCPT2", "OTHERWRVU2", "OTHERPROC3", "OTHERCPT3", "OTHERWRVU3", "OTHERPROC4", "OTHERCPT4", "OTHERWRVU4", "OTHERPROC5", "OTHERCPT5", "OTHERWRVU5", "CONCURR1", "CONCPT1", "CONWRVU1", "CONCURR2", "CONCPT2", "CONWRVU2", "CONCURR3", "CONCPT3", "CONWRVU3", "CONCURR4", "CONCPT4", "DPRNA", "DPRBUN", "DPRCREAT", "DPRALBUM", "DPRBILI", "DPRSGOT", "DPRALKPH", "DPRWBC", "DPRHCT", "DPRPLATE", "DPRPTT", "DPRPT", "DPRINR", "DSUPINFEC", "DWNDINFD","DORGSPCSSI", "DDEHIS", "DOUPNEUMO", "DREINTUB", "DPULEMBOL", "DFAILWEAN","DRENAINSF", "DOPRENAFL", "DURNINFEC", "DCNSCVA", "DCDARREST", "DCDMI", "DOTHBLEED", "DOTHDVT", "DOTHSYSEP", "DOTHSESHOCK", "DOPERTOD", "RETORPODAYS")

drop_labs_missing <- c("DPRNA", "DPRBUN", "DPRCREAT", "DPRALBUM", "DPRBILI", "DPRSGOT")

df_simplified <- select(df_simplified, -original_drop)

colnames(df_simplified)
```


```{r}


```


```{r}


```
